<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
</head>

<body>
  <form>
    <label for="supplyU0">Peak supply voltage [V]:</label>
    <input type="number" id="supplyU0" value="10"><br><br>

    <label for="dischargeR">Lamp resistance [Ω]:</label>
    <input type="number" id="dischargeR" value="50"><br><br>

    <label for="simTime">Simulation time [s]:</label>
    <input type="number" id="simTime" value="1"><br><br>

    <label for="frequency">Frequency [Hz]:</label>
    <input type="number" id="frequency" value="110"><br><br>

    <label for="dutyCycle">Duty cycle [%]:</label>
    <input type="number" id="dutyCycle" value="85"><br><br>

    <label for="switchTime">Switching Time [ms]:</label>
    <input type="number" id="switchTime" value="60"><br><br>

    <label for="chargeR1">Charging Resistor1 [Ω]:</label>
    <input type="number" id="chargeR1" value="20"><br><br>

    <label for="capacitance1">Capacitance1 [µF]:</label>
    <input type="number" id="capacitance1" value="500"><br><br>

    <label for="chargeR2">Charging Resistor2 [Ω]:</label>
    <input type="number" id="chargeR2" value="20"><br><br>

    <label for="capacitance2">Capacitance2 [µF]:</label>
    <input type="number" id="capacitance2" value="5000"><br><br>

    <input type="submit" value="Run" id="runButton">
  </form>
  <div id="output"></div>
  <canvas id="voltageChart"></canvas>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.getElementById("runButton").addEventListener("click", function (event) {
        event.preventDefault(); // Prevent form submission
        runSim();
      });
    });

    function runSim() {
      let supplyU0 = parseFloat(document.getElementById("supplyU0").value) || 0;
      let simTime = parseFloat(document.getElementById("simTime").value) || 0;
      let frequency = parseFloat(document.getElementById("frequency").value) || 0;
      let dutyCycle = parseFloat(document.getElementById("dutyCycle").value) / 100;
      let switchTime = parseFloat(document.getElementById("switchTime").value) / 1000;
      let dischargeR = parseFloat(document.getElementById("dischargeR").value) || 0;
      let chargeR1 = parseFloat(document.getElementById("chargeR1").value) || 0;
      let capacitance1 = parseFloat(document.getElementById("capacitance1").value) || 0;
      let chargeR2 = parseFloat(document.getElementById("chargeR2").value) || 0;
      let capacitance2 = parseFloat(document.getElementById("capacitance2").value) || 0;

      if (supplyU0 <= 0 || chargeR1 <= 0 || dischargeR <= 0 || capacitance1 <= 0 || capacitance2 <= 0 || simTime <= 0 || frequency <= 0 || dutyCycle <= 0 || dutyCycle > 1 || switchTime < 0) {
        console.error("All input values must be positive numbers.");
        document.getElementById("output").innerHTML = "Error: All input values must be positive numbers.";
        return;
      }

      let voltageCapacitor1 = 0;
      let voltageCapacitor2 = 0;
      let voltageLamp = 0;
      let currentCapacitor1 = supplyU0 / chargeR1;
      let currentCapacitor2 = supplyU0 / chargeR2;
      let currentSupply = supplyU0 / dischargeR + supplyU0 / chargeR1 + supplyU0 / chargeR2;

      let periodTime = 1 / frequency;
      let tauChargeCapacitor1 = chargeR1 * capacitance1 * 1e-6;
      let tauDischargeCapacitor1 = dischargeR * capacitance1 * 1e-6;
      let tauChargeCapacitor2 = chargeR2 * capacitance2 * 1e-6;
      let tauDischargeCapacitor2 = dischargeR * capacitance2 * 1e-6;
      let tauDischargeCapacitors = dischargeR * (capacitance1 + capacitance2) * 1e-6;
      let timeData = [];
      let voltageDataCapacitor1 = [];
      let voltageDataCapacitor2 = [];
      let voltageDataLamp = [];
      let currentDataLamp = [];
      let currentDataCapacitor1 = [];
      let currentDataCapacitor2 = [];
      let currentDataSupply = [];
      timeData.push(0);
      voltageDataCapacitor1.push(0);
      voltageDataCapacitor2.push(0);
      voltageDataLamp.push(0);
      currentDataCapacitor1.push(currentCapacitor1);
      currentDataCapacitor2.push(currentCapacitor2);
      currentDataSupply.push(currentSupply);

      for (let time = 0; time < simTime;) {

        // Charging phase
        voltageCapacitor1 += (supplyU0 - voltageCapacitor1) * (1 - Math.exp(-((periodTime * dutyCycle) / tauChargeCapacitor1)));
        voltageCapacitor2 += (supplyU0 - voltageCapacitor2) * (1 - Math.exp(-((periodTime * dutyCycle) / tauChargeCapacitor2)));

        currentCapacitor1 = (supplyU0 - voltageCapacitor1) / chargeR1;
        currentCapacitor2 = (supplyU0 - voltageCapacitor2) / chargeR2;
        currentSupply = supplyU0 / dischargeR + (supplyU0 - voltageCapacitor1) / chargeR1 + (supplyU0 - voltageCapacitor2) / chargeR2;

        timeData.push(time + dutyCycle * periodTime);
        voltageDataCapacitor1.push(voltageCapacitor1);
        voltageDataCapacitor2.push(voltageCapacitor2);
        voltageDataLamp.push(supplyU0);
        currentDataSupply.push(currentSupply);
        currentDataCapacitor1.push(currentCapacitor1);
        currentDataCapacitor2.push(currentCapacitor2);

        // Discharging phase
        tempvoltageCapacitor1 = voltageCapacitor1 * Math.exp(-((periodTime * (1 - dutyCycle)) / tauDischargeCapacitor1));
        tempvoltageCapacitor2 = voltageCapacitor2 * Math.exp(-((periodTime * (1 - dutyCycle)) / tauDischargeCapacitor2));

        if (voltageCapacitor1 < voltageCapacitor2) {
          if (tempvoltageCapacitor1 > tempvoltageCapacitor2) {
            voltageCapacitor1 = voltageCapacitor2 = (voltageCapacitor1 * capacitance1 + voltageCapacitor2 * capacitance2) / (capacitance1 + capacitance2) * Math.exp(-((periodTime * (1 - dutyCycle)) / tauDischargeCapacitors));
          }
          else {
            voltageCapacitor2 = voltageCapacitor2 * Math.exp(-((periodTime * (1 - dutyCycle)) / tauDischargeCapacitor2));
          }
        }
        if (voltageCapacitor1 > voltageCapacitor2) {
          if (tempvoltageCapacitor1 < tempvoltageCapacitor2) {
            voltageCapacitor1 = voltageCapacitor2 = (voltageCapacitor1 * capacitance1 + voltageCapacitor2 * capacitance2) / (capacitance1 + capacitance2) * Math.exp(-((periodTime * (1 - dutyCycle)) / tauDischargeCapacitors));
          }
          else {
            voltageCapacitor1 = voltageCapacitor1 * Math.exp(-((periodTime * (1 - dutyCycle)) / tauDischargeCapacitor1));
          }
        }


        timeData.push(time + periodTime);
        voltageDataCapacitor1.push(voltageCapacitor1);
        voltageDataCapacitor2.push(voltageCapacitor2);
        voltageDataLamp.push(Math.max(voltageCapacitor1, voltageCapacitor2));
        currentDataSupply.push(0);
        currentDataCapacitor1.push(0);
        currentDataCapacitor2.push(0);

        time += periodTime;
      }


      timeData.push(simTime + switchTime);

      voltageCapacitor1 = voltageCapacitor2 = (voltageCapacitor1 * capacitance1 + voltageCapacitor2 * capacitance2) / (capacitance1 + capacitance2) * Math.exp(-((switchTime) / tauDischargeCapacitors));

      voltageDataCapacitor1.push(voltageCapacitor1);
      voltageDataCapacitor2.push(voltageCapacitor2);
      voltageDataLamp.push(Math.max(voltageCapacitor1, voltageCapacitor2));

      drawChart(timeData, voltageDataCapacitor1, voltageDataCapacitor2, voltageDataLamp, currentDataSupply, currentDataCapacitor1, currentDataCapacitor2);
    }

    function drawChart(timeData, voltageDataCapacitor1, voltageDataCapacitor2, voltageDataLamp, currentDataSupply, currentDataCapacitor1, currentDataCapacitor2) {
      let ctx = document.getElementById("voltageChart").getContext("2d");

      if (window.voltageChart instanceof Chart) {
        window.voltageChart.destroy();
      }

      window.voltageChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: timeData,
          datasets: [
            {
              label: "Voltage Capacitor 1 [V]",
              data: voltageDataCapacitor1,
              borderColor: "blue",
              borderWidth: 1,
              fill: false,
              yAxisID: "y"
            },
            {
              label: "Voltage Capacitor 2 [V]",
              data: voltageDataCapacitor2,
              borderColor: "green",
              borderWidth: 1,
              fill: false,
              yAxisID: "y"
            },
            {
              label: "Voltage Lamp [V]",
              data: voltageDataLamp,
              borderColor: "red",
              borderWidth: 1,
              fill: false,
              yAxisID: "y"
            },
            {
              label: "Current Supply [A]",
              data: currentDataSupply,
              borderColor: "purple",
              borderWidth: 1,
              fill: false,
              yAxisID: "y1"
            },
            {
              label: "Current Capacitor 1 [A]",
              data: currentDataCapacitor1,
              borderColor: "yellow",
              borderWidth: 1,
              fill: false,
              yAxisID: "y1"
            },
            {
              label: "Current Capacitor 2 [A]",
              data: currentDataCapacitor2,
              borderColor: "brown",
              borderWidth: 1,
              fill: false,
              yAxisID: "y1"
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              title: {
                display: true,
                text: "Time [s]"
              },
              type: "linear"
            },
            y: {
              title: {
                display: true,
                text: "Voltage [V]"
              },
              position: "left"
            },
            y1: {
              title: {
                display: true,
                text: "Current [A]"
              },
              position: "right",
              grid: {
                drawOnChartArea: false
              }
            }
          },
          plugins: {
            zoom: {
              pan: {
                enabled: true,
                mode: 'xy',
              },
              zoom: {
                wheel: {
                  enabled: true,
                  modifierKey: 'shift',
                },
                mode: 'xy',
                scaleMode: 'xy',
              }
            }
          }
        }
      });
    }
  </script>
</body>

</html>